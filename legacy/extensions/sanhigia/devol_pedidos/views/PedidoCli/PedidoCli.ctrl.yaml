---
shortcuts:
  - type: Model
    name: historico
    id: referencia
    schema: historicoPedidosCliente
    action: get_historico_pedidos
state:
  status:
    enviandoPda: false
    viendoTracking: false
bunch:
  # En sanhigia cargamos siempre todas las líneas por la revisión
  # en la totalización que cambia precios y crea líneas regalo
  onLineasItemChanged:
    - _type: grape
      name: reloadPedido
    - _type: grape
      name: getLineas
  onLineaCreada:
    - _type: grape
      name: reloadPedido
    - _type: grape
      name: getLineas
  onEnviarPDAClicked:
    - _type: patch
      schema: pedidos
      action: enviar_pda
      id:
        statePath: pedido.buffer.idPedido
      success: onPedidoEnviadoPDA
      error: onEnviarPDAError
    - _type: set
      path: status.enviandoPda
      value:
        const: true
  onEnviarPDAError:
    - _type: set
      path: status.enviandoPda
      value:
        const: false
    - _type: alert
      text: Error al enviar el pedido
      severity: error
  onPedidoEnviadoPDA:
    - _type: set
      path: status.enviandoPda
      value:
        const: false
    - _type: grape
      name: reloadPedido
    - _type: alert
      text: Pedido enviado
      severity: success
  onAnadirLineaDesdeHistoricoClicked:
    - _type: setItem
      condition:
          operator: A is true
          A:
            code: 'return !payload.referencia.includes(".")'
      path: historico.dict
      key:
        payloadPath: referencia
      prop:
        const: "_status"
      value:
        const: creating_line
    - _type: grape
      condition:
          operator: A is true
          A:
            code: 'return payload.referencia.includes(".")'    
      name: seteaStatusCreatingLine
    - _type: patch
      action: build_linea
      schema: pedidos
      id:
        statePath: pedido.buffer.idPedido
      success: onLineaHistoricoAnadida
      data:
        - key: referencia
          value:
            payloadPath: referencia
        - key: cantidad
          value:
            payloadPath: cantidad
  onLineaHistoricoAnadida:
    - _type: grape
      name: addLineasItem
      payload:
        id:
          payloadPath: response.pk
        event:
          const: created
    - _type: grape
      name: reloadPedido
    - _type: grape
      name: deleteKeyHistorico
      payload:
        referencia:
          payloadPath: referencia
  # onInitPedidoChanged:
  #   - _type: grape
  #     name: getHistoricoSiHayCliente
  onInitPedido:
    patch: append
    grapes:
      - _type: grape
        name: getHistoricoSiHayCliente
  getHistoricoSiHayCliente:
    - condition:
        operator: A is true
        A:
          code: return !!state.pedido?.buffer.codCliente
      _type: grape
      name: getHistorico
  onShVerTrackingClicked:
    - _type: get
      schema: pedidos
      action: sh_url_tracking
      id:
        statePath: pedido.data.idPedido
      success: onShTrackingRecibido
  onShTrackingRecibido:
    - _type: navigate
      url:
        payloadPath: response.urlTracking
  onShLineaPromoClicked:
    - _type: patch
      schema: pedidos
      id:
        statePath: pedido.data.idPedido
      data:
        - key: idlinea
          value:
            statePath: lineas.current
      action: add_linea_promocion
      success: onLineaPromoAdded
  onLineaPromoAdded:
    - _type: grape
      name: onLineasItemChanged


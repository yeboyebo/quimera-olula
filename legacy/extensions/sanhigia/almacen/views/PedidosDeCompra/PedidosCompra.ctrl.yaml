---
shortcuts:
  - type: Model
    name: pedidosProv
    id: idPedido
    schema: pedidosCompra
    url: "/pedidosdecompra"
    action: "get_pedidos_compra"
    logicDelete: false
state:
  filtroVisible: false
  habilitarMulticheck: false
  arrayMultiCheck: []
  checkClicked:  false
bunch:
  onInit:
    - _type: grape
      name: checkPedidosProvFilterSaved  
  onMostrarFiltroClicked:
    - _type: set
      path: filtroVisible
      value:
        toggleStatePath: filtroVisible        
  # onPedidosProvFilterChanged:
  #   patch: override
  #   grapes:
  #     - _type: grape
  #       name: onMostrarFiltroClicked
  #     - _type: set
  #       path: pedidos.filter
  #       value:
  #         payloadPath: value      
  #     - condition:
  #         operator: A is true
  #         A:
  #           code: 'return !!state.ref1Filtro' 
  #       _type: grape
  #       name: comprobarFiltrosFueraSchema
  #     - _type: grape
  #       name: getPedidosProv
  #     - _type: grape
  #       name: resetearAcciones
  comprobarFiltrosFueraSchema:
    - _type: if
      if:
        operator: A is true
        A:
          code: 'return !state.pedidos.filter?.and && !!state.pedidos.filter' 
      then:
          # Limpiando filtros
        _type: grape
        name: limpiaFiltrosFueraSchema 
      else:
        # Filtrando
        _type: grape
        name: comprobarFiltrosAgregados 
  limpiaFiltrosFueraSchema:   
    - _type: set
      path: pedidosPdtesFiltro
      value:
        const: false 
    - _type: set
      path: pedidosCompletarFiltro
      value:
        const: false  
    # - _type: set
    #   path: codProveedorFiltro
    #   value:
    #     const: null    
    - _type: set
      path: ref1Filtro
      value:
        const: null   
    - _type: set
      path: ref2Filtro
      value:
        const: null                                 
  comprobarFiltrosAgregados:       
    - _type: if
      if:
        operator: A is true
        A:
          code: 'return !!state.pedidos.filter?.and' 
      then:
        _type: grape
        name: addFiltrosFueraSchema
      else:
        _type: grape
        name: addAndFiltrosFueraSchema
  addFiltrosFueraSchema:                       
      # - condition:
      #     operator: A is defined
      #     A:
      #       statePath: codProveedorFiltro
      #   _type: appendItem
      #   path: pedidos.filter.and
      #   value:
      #     code: 'return ["codproveedor", "eq", state.codProveedorFiltro]'
      - _type: grape
        name: addFiltroReferenciaUnica
  addFiltroReferenciaUnica:   
      - condition:
          operator: A is defined
          A:
            statePath: ref1Filtro
        _type: appendItem
        path: pedidos.filter.and
        value:
          code: 'return ["referencia", "eq", state.ref1Filtro]'   
  addAndFiltrosFueraSchema:   
      - _type: set
        path: pedidos.filter
        value:
          code: 'return { and: []}'  
      - _type: grape
        name: addFiltrosFueraSchema             
  onHabilitarMulticheckClicked:  
      - condition:
          operator: A is true
          A:
            statePath: habilitarMulticheck
        _type: set
        path: arrayMultiCheck
        value:
          const: []    
      - _type: set
        path: habilitarMulticheck
        value:
         toggleStatePath: habilitarMulticheck
  onPedidosCheckItemChecked:  
    - _type: appendItem
      path: arrayMultiCheck
      value:
        payloadPath: idPedido 
    - _type: set
      path: checkClicked
      value:
        const: true 
  onPedidosCheckItemCheckout:
    - _type: deleteItemByIndex
      path: arrayMultiCheck
      index:
        payloadPath: index 
    - _type: set
      path: checkClicked
      value:
        const: true 
  onBotonAgruparPedidosClicked:    
    - _type: patch
      schema: pedidosCompra
      action: check_array_agrupacion
      data:
        - key: pedidos
          value:
            statePath: arrayMultiCheck            
      success: onAgruparPedidosResponse
  onAgruparPedidosResponse:
    - _type: log
      desc: miMensajeLineaguarda
      value: 
        payloadPath: response
    - _type: if
      if:
        operator: A is defined
        A:
          payloadPath: response
      then:
        _type: grape
        name: onAgruparPedidosSuccess 
      else:
        _type: alert
        text: Los proveedores no co√≠nciden.
        severity: error    
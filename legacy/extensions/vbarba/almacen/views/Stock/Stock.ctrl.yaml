---
shortcuts:
  - type: DetailBuffer
    name: stock
    id: referencia
    schemaName: stocks
    deleteConfirmQuestion:
      titulo: Borrar stock
      cuerpo: El stock se borrará
state:
  modalAddAlmacen: false
  nuevoAlmacen: ""
  almacenes: []
  miFinca: {}
  totalStockFinca: 0
  callbackChanged: null
bunch: 
  onInit: 
    - _type: set 
      path: callbackChanged
      value:
        payloadPath: callbackChanged         
    - _type: set
      path: miFinca
      value: 
        localStorageValue: finca
    - _type: grape
      name: cargaAlmacenes
  onInitStockByIdPrevio:
    - _type: set
      path: miFinca
      value: 
        localStorageValue: finca         
    - condition:
        operator: A is defined
        A:
          localStorageValue: finca
      _type: grape
      name: onInitStockById
      payload:
        getStockParams:
          code: 'return {codFinca: state.miFinca.codfinca}'               
  cargaAlmacenes:     
    - _type: patch
      schema: stocks
      action: get_stock_almacenes
      id:
        statePath: stock.buffer.idstock
      data:
        - key: codfinca
          value:
            statePath: miFinca.codfinca
        - key: referencia
          value:
            statePath: stock.buffer.referencia
      success: onGetAlmacenesSucceded      
  onGetAlmacenesSucceded:  
    - _type: set
      path: almacenes
      value: 
        payloadPath: response.almacenes
    - _type: set
      path: totalStockFinca
      value: 
        payloadPath: response.totalStockFinca  
  cambiarCantidadStock:
    - _type: patch
      schema: stocks
      action: cambiar_cantidad
      id:
        payloadPath: almacen.idstock
      data:
        - key: idstock
          value:
            payloadPath: almacen.idstock
        - key: codalmacen
          value:
            payloadPath: almacen.codalmacen            
        - key: cantidadfinal
          value:
            payloadPath: almacen.cantidad            
        - key: descripcion
          value:
            statePath: stock.data.descripcion 
        - key: referencia
          value:
            statePath: stock.buffer.referencia                    
      success: onCambiarCantidadSucceded  
  onCambiarCantidadSucceded: 
    - _type: setItem
      path: almacenes
      key:
        payloadPath: response.codalmacen
      prop:
        const: "cantidad"
      value:
        payloadPath: response.cantidadfin            
    - _type: grape
      name: cargaAlmacenes      
    - _type: alert
      text: Cantidad de stock modificada.
      severity: success      
  sumarCantidad:   
    - _type: patch
      schema: stocks
      action: sumar_cantidad
      id:
        statePath: almacen.idstock
      data:
        - key: idstock
          value:
            payloadPath: almacen.idstock
        - key: codalmacen
          value:
            payloadPath: almacen.codalmacen            
        - key: cantidadinicial
          value:
            payloadPath: almacen.cantidad            
        - key: cantidadsumar
          value:
            payloadPath: value 
        - key: descripcion
          value:
            statePath: stock.data.descripcion 
        - key: referencia
          value:
            statePath: stock.buffer.referencia                    
      success: onSumarCantidadSucceded  
  onSumarCantidadSucceded: 
    - _type: setItem
      path: almacenes
      key:
        payloadPath: response.codalmacen
      prop:
        const: "cantidad"
      value:
        payloadPath: response.cantidadfin            
    - _type: set
      path: totalStockFinca
      value: 
        code: return state.totalStockFinca + parseInt(payload.response.cantidadsumar)
    # - _type: setItem
    #   path: almacenes
    #   key:
    #     payloadPath: response.codalmacen
    #   prop:
    #     const: "suma"
    #   value:
    #     const: 0           
    - _type: alert
      text: Cantidad de stock modificada.
      severity: success              
  onDetalleUbicacionChanged:
    - _type: setItem
      path: almacenes
      key:
        payloadPath: codalmacen
      prop:
        const: "detalleubicacion"
      value:
        payloadPath: value
  onCantidadStockChanged:
    - _type: setItem
      path: almacenes
      key:
        payloadPath: codalmacen
      prop:
        const: "cantidad"
      value:
        payloadPath: value               
  cambiarDetalleUbicacion:
    - _type: patch
      schema: stocks
      id:
        payloadPath: almacen.idstock
      data:
        - key: detalleubicacion
          value:
            payloadPath: value
      success: onDetalleUbicaonCambiado   
  onDetalleUbicaonCambiado:
    - _type: alert
      text: Detalle de ubicación de stock modificado.
      severity: success   
  onVolverClicked:
    - _type: navigate 
      url:
        code: 'return "/stocks"'
    # - _type: grape
    #   name: cancelStock
  onVerImagenClicked:
    - _type: get
      schema: articuloimages
      action: get_url_image
      id:
        statePath: stock.buffer.referencia
      success: onGetUrlImageSucceded  
  onGetUrlImageSucceded:
    - _type: navigate
      url:
        payloadPath: response.direccion
  # onEditarArticuloClicked: 
  #   - _type: navigate
  #     url:
  #       const: 
  #         code: return `/articulos/${state.stock.data.referencia}`
  onCambiarDisponibleClicked:
    - _type: patch
      schema: stocks
      action: cambiar_disponible
      id:
        statePath: stock.data.idarticuloprov
      data:
        - key: disponible
          value:
            code: return !state.stock.data.disponible 
        - key: referencia
          value:
            statePath: stock.data.referencia   
        - key: codproveedor
          value:
            statePath: miFinca.codproveedor    
        - key: nombreProveedor
          value:
            statePath: miFinca.nombreproveedor                   
      success: onDisponibleActualizado
  onDisponibleActualizado:   
    - _type: set
      path: stock.data.disponible
      value:
        payloadPath: response.disponible    
    - _type: set
      path: stock.buffer.disponible
      value:
        payloadPath: response.disponible 
    - _type: alert
      text: Disponibilidad actualizada.
      severity: success  
    - _type: grape
      name: stockCambiado
      payload:
        field:
          const: disponible 
        value:
          statePath: stock.data.disponible                                        
  onAddAlmacenClicked: 
    - _type: set
      path: modalAddAlmacen
      value: 
        const: true  
  onCerrarAddAlmacenConfirm:
    - _type: set
      path: modalAddAlmacen
      value: 
        const: false        
    - _type: set
      path: nuevoAlmacen
      value: 
        const: ''  
  onAddAlmacenConfirmClicked:
    - _type: if
      if:
        operator: A is defined
        A:
          code: return state.almacenes[state.nuevoAlmacen.codalmacen] 
      then:
        _type: alert
        text: Este almacén ya está añadido.
        severity: warning
      else:
        _type: patch
        schema: stocks
        action: add_almacen
        data:
          - key: codalmacen
            value:
              statePath: nuevoAlmacen.codalmacen 
          - key: referencia
            value:
              statePath: stock.data.referencia
        success: onAlmacenAnadido    
  onAlmacenAnadido:    
    - _type: grape
      name: cargaAlmacenes            
    - _type: grape
      name: onCerrarAddAlmacenConfirm     
    - _type: alert
      text: Almacén añadido.
      severity: success
  onImagenAdjuntada:   
    - _type: patch
      schema: articuloimages
      action: update_image
      id:
        statePath: stock.data.referencia
      files:
        payloadPath: files
      success: onImagenActualizada
      error: onImagenActualizadaError  
  onImagenActualizada:
    - _type: set
      path: stock.data.tieneFoto
      value:
        const: true    
    - _type: set
      path: stock.buffer.tieneFoto
      value:
        const: true 
    - _type: alert
      text: Imagen añadida.
      severity: success          
  onImagenActualizadaError:  
    - _type: alert
      text: 'Error: La imagen no se ha podido almacenar.'
      severity: error            

